<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Book a Service - ScrubIt Client</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    
    <!-- Custom Styles for Branding and Aesthetics -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root {
            --custom-blue: #3f51b5; /* Primary accent */
            --custom-green: #00897b; /* Success/Main action */
        }
        body { font-family: 'Inter', sans-serif; background-color: #f4f5f7; }
        .bg-custom-green { background-color: var(--custom-green); }
        .text-custom-green { color: var(--custom-green); }
        .border-custom-green { border-color: var(--custom-green); }
        .hover\:bg-custom-green:hover { background-color: #00796b; } 
        .bg-custom-blue { background-color: var(--custom-blue); }
        .text-custom-blue { color: var(--custom-blue); }
        .hover\:bg-custom-blue:hover { background-color: #3040a0; }

        /* Step Indicator Styling */
        .step-indicator {
            width: 3rem; 
            height: 3rem; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 9999px; /* full circle */
            font-weight: 600;
            transition: all 0.3s ease;
            flex-shrink: 0;
            z-index: 10;
        }
        .step-active {
            background-color: var(--custom-green);
            color: white;
            box-shadow: 0 4px 10px rgba(0, 137, 123, 0.4);
        }
        .step-complete {
            background-color: var(--custom-blue);
            color: white;
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        /* Hide HTML inputs for custom radio/checkbox styling */
        .radio-card input[type="radio"], 
        .checkbox-extra input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        /* Style the card when the input is checked */
        .radio-card input[type="radio"]:checked + label {
            border-color: var(--custom-green);
            background-color: #e6fffb; /* Light teal background */
            box-shadow: 0 0 0 3px rgba(0, 137, 123, 0.3);
            transform: scale(1.02);
        }
        
        /* New styling for product preference radios */
        .radio-card input[name="product_preference"]:checked + label {
            border-color: var(--custom-blue);
            background-color: #e8eaf6; /* Light blue background */
            box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.3);
            transform: scale(1.02);
        }

        .checkbox-extra input[type="checkbox"]:checked + label {
            border-color: var(--custom-blue);
            background-color: #e8eaf6; /* Light blue background */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">



    <!-- Top Navigation (Desktop View) -->
    <header class="hidden md:flex bg-white shadow-md p-4 sticky top-0 z-20">
        <div class="container mx-auto flex justify-between items-center">
            <div class="text-2xl font-bold text-custom-green">ScrubIt</div>
            <nav class="flex space-x-8 text-gray-700 font-medium">
                <a href="#" class="hover:text-custom-green transition-colors">Home</a>
                <a href="#" class="text-custom-green font-semibold border-b-2 border-custom-green pb-1">Book Now</a>
                <a href="#" class="hover:text-custom-green transition-colors">My Bookings</a>
                <a href="#" class="hover:text-custom-green transition-colors">Support</a>
            </nav>
            <a href="#" id="profile-link" class="w-10 h-10 bg-custom-blue text-white rounded-full flex items-center justify-center text-lg hover:ring-2 ring-custom-blue transition-all" title="Profile/Account">
                <i class="fa-solid fa-user"></i>
            </a>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow p-4 md:p-8">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800 mb-6 text-center">Book Your Cleaning Service</h1>
            
            <!-- Step Indicators and Progress Bar -->
            <div class="relative flex justify-between items-center mb-10 mt-8">
                <!-- Progress Line -->
                <div class="absolute top-1/2 left-0 w-full h-1 bg-gray-300 z-0 transform -translate-y-1/2">
                    <div id="progress-fill" class="h-full bg-custom-green transition-all duration-500 rounded-full" style="width: 0%;"></div>
                </div>

                <!-- Indicators -->
                <div id="step-indicator-1" class="step-indicator step-active">1</div>
                <div id="step-indicator-2" class="step-indicator bg-gray-300 text-gray-600">2</div>
                <div id="step-indicator-3" class="step-indicator bg-gray-300 text-gray-600">3</div>
            </div>

            <form id="booking-form" class="bg-white p-6 md:p-10 rounded-xl shadow-2xl space-y-8">
                <!-- Step Title -->
                <h2 id="step-title" class="text-xl md:text-2xl font-bold text-gray-700 mb-6 text-center">Step 1: Choose Service & Size</h2>

                <!-- Hidden Message Area -->
                <p id="form-message" class="text-center text-sm font-semibold mt-4 transition-all duration-300 hidden"></p>

                <!-- === STEP 1: SERVICE SELECTION === -->
                <div id="step-1" class="form-step transition-all duration-500 ease-in-out">
                    <div class="space-y-6">
                        <label class="block text-gray-700 font-semibold mb-2">1. Select Service Type <span class="text-red-500">*</span></label>
                        <div class="grid grid-cols-2 gap-4 md:grid-cols-4">
                            <!-- Service Type Radios -->
                            <div class="radio-card">
                                <input type="radio" id="service_standard" name="service_type" value="Standard" required>
                                <label for="service_standard" class="block p-4 border-2 border-gray-200 rounded-xl cursor-pointer transition-all duration-200 hover:border-custom-green shadow-sm text-center">
                                    <i class="fa-solid fa-broom text-2xl text-custom-green mb-2"></i>
                                    <span class="font-medium text-gray-800 block">Standard Clean</span>
                                    <span class="text-xs text-gray-500">Regular maintenance</span>
                                </label>
                            </div>
                            <div class="radio-card">
                                <input type="radio" id="service_deep" name="service_type" value="Deep" required>
                                <label for="service_deep" class="block p-4 border-2 border-gray-200 rounded-xl cursor-pointer transition-all duration-200 hover:border-custom-green shadow-sm text-center">
                                    <i class="fa-solid fa-house-chimney-crack text-2xl text-custom-green mb-2"></i>
                                    <span class="font-medium text-gray-800 block">Deep Clean</span>
                                    <span class="text-xs text-gray-500">Intensive cleaning</span>
                                </label>
                            </div>
                            <div class="radio-card">
                                <input type="radio" id="service_move" name="service_type" value="Move In/Out" required>
                                <label for="service_move" class="block p-4 border-2 border-gray-200 rounded-xl cursor-pointer transition-all duration-200 hover:border-custom-green shadow-sm text-center">
                                    <i class="fa-solid fa-truck-moving text-2xl text-custom-green mb-2"></i>
                                    <span class="font-medium text-gray-800 block">Move In/Out</span>
                                    <span class="text-xs text-gray-500">Empty home cleaning</span>
                                </label>
                            </div>
                            <div class="radio-card">
                                <input type="radio" id="service_hourly" name="service_type" value="Hourly" required>
                                <label for="service_hourly" class="block p-4 border-2 border-gray-200 rounded-xl cursor-pointer transition-all duration-200 hover:border-custom-green shadow-sm text-center">
                                    <i class="fa-solid fa-hourglass-start text-2xl text-custom-green mb-2"></i>
                                    <span class="font-medium text-gray-800 block">Hourly Rate</span>
                                    <span class="text-xs text-gray-500">Custom tasks</span>
                                </label>
                            </div>
                        </div>

                        <!-- Property Size Selection -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4">
                            <div>
                                <label for="bedrooms" class="block text-gray-700 font-semibold mb-2">2. Bedrooms <span class="text-red-500">*</span></label>
                                <select id="bedrooms" name="bedrooms" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-custom-green focus:border-custom-green transition-colors">
                                    <option value="" disabled selected>Select number of bedrooms</option>
                                    <option value="1">1 Bedroom</option>
                                    <option value="2">2 Bedrooms</option>
                                    <option value="3">3 Bedrooms</option>
                                    <option value="4+">4+ Bedrooms</option>
                                </select>
                            </div>
                            <div>
                                <label for="bathrooms" class="block text-gray-700 font-semibold mb-2">3. Bathrooms <span class="text-red-500">*</span></label>
                                <select id="bathrooms" name="bathrooms" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-custom-green focus:border-custom-green transition-colors">
                                    <option value="" disabled selected>Select number of bathrooms</option>
                                    <option value="1">1 Bathroom</option>
                                    <option value="2">2 Bathrooms</option>
                                    <option value="3">3 Bathrooms</option>
                                    <option value="4+">4+ Bathrooms</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- === STEP 2: DATE AND LOCATION === -->
                <div id="step-2" class="form-step hidden transition-all duration-500 ease-in-out">
                    <div class="space-y-6">
                        <!-- Location/Address -->
                        <label class="block text-gray-700 font-semibold mb-2 flex justify-between items-center">
                            <span>1. Service Address <span class="text-red-500">*</span></span>
                            <!-- NEW CHECKBOX FOR SAVED ADDRESS -->
                            <div class="flex items-center">
                                <input type="checkbox" id="use-saved-address" class="w-4 h-4 text-custom-blue bg-gray-100 border-gray-300 rounded focus:ring-custom-blue" onclick="toggleUseSavedAddress()">
                                <label for="use-saved-address" class="ml-2 text-sm text-custom-blue font-medium hover:text-custom-green transition-colors cursor-pointer select-none">
                                    Use My Saved Address
                                </label>
                            </div>
                        </label>

                        <input type="text" id="address" name="address" placeholder="Street Address" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-custom-green focus:border-custom-green transition-colors mb-4">
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input type="text" id="city" name="city" placeholder="City" required class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-custom-green focus:border-custom-green transition-colors">
                            <input type="text" id="state" name="state" placeholder="State/Province" required class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-custom-green focus:border-custom-green transition-colors">
                            <input type="text" id="zip" name="zip" pattern="\d{5}(?:-\d{4})?|\d{6}" placeholder="Zip Code" required class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-custom-green focus:border-custom-green transition-colors">
                        </div>

                        <!-- Date and Time -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4">
                            <div>
                                <label for="service_date" class="block text-gray-700 font-semibold mb-2">2. Preferred Date <span class="text-red-500">*</span></label>
                                <input type="date" id="service_date" name="service_date" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-custom-green focus:border-custom-green transition-colors">
                            </div>
                            <div>
                                <label for="service_time" class="block text-gray-700 font-semibold mb-2">3. Preferred Time Slot <span class="text-red-500">*</span></label>
                                <select id="service_time" name="service_time" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-custom-green focus:border-custom-green transition-colors">
                                    <option value="" disabled selected>Select a time slot</option>
                                    <option value="8:00 AM - 12:00 PM">Morning (8:00 AM - 12:00 PM)</option>
                                    <option value="12:00 PM - 4:00 PM">Afternoon (12:00 PM - 4:00 PM)</option>
                                    <option value="4:00 PM - 8:00 PM">Evening (4:00 PM - 8:00 PM)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- === STEP 3: EXTRAS, LOGISTICS, AND CONFIRMATION === -->
                <div id="step-3" class="form-step hidden transition-all duration-500 ease-in-out">
                    <div class="space-y-8">
                        <!-- 1. Add-ons Section -->
                        <div>
                            <label class="block text-gray-700 text-xl font-bold mb-4">1. Cleaning Add-ons (Optional)</label>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="checkbox-extra">
                                    <input type="checkbox" id="extra_oven" name="extras" value="Oven Cleaning">
                                    <label for="extra_oven" class="block p-4 border-2 border-gray-200 rounded-lg cursor-pointer transition-all duration-200 hover:border-custom-blue text-center">
                                        <i class="fa-solid fa-fire-burner text-xl text-custom-blue mb-1"></i>
                                        <span class="text-sm font-medium">Oven Cleaning</span>
                                    </label>
                                </div>
                                <div class="checkbox-extra">
                                    <input type="checkbox" id="extra_windows" name="extras" value="Interior Windows">
                                    <label for="extra_windows" class="block p-4 border-2 border-gray-200 rounded-lg cursor-pointer transition-all duration-200 hover:border-custom-blue text-center">
                                        <i class="fa-solid fa-window-restore text-xl text-custom-blue mb-1"></i>
                                        <span class="text-sm font-medium">Interior Windows</span>
                                    </label>
                                </div>
                                <div class="checkbox-extra">
                                    <input type="checkbox" id="extra_laundry" name="extras" value="Laundry Service">
                                    <label for="extra_laundry" class="block p-4 border-2 border-gray-200 rounded-lg cursor-pointer transition-all duration-200 hover:border-custom-blue text-center">
                                        <i class="fa-solid fa-shirt text-xl text-custom-blue mb-1"></i>
                                        <span class="text-sm font-medium">Laundry Service</span>
                                    </label>
                                </div>
                                <div class="checkbox-extra">
                                    <input type="checkbox" id="extra_fridge" name="extras" value="Fridge Interior">
                                    <label for="extra_fridge" class="block p-4 border-2 border-gray-200 rounded-lg cursor-pointer transition-all duration-200 hover:border-custom-blue text-center">
                                        <i class="fa-solid fa-temperature-arrow-down text-xl text-custom-blue mb-1"></i>
                                        <span class="text-sm font-medium">Fridge Interior</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- 2. NEW SECTION: Logistics & Preferences -->
                        <div class="pt-4 border-t border-gray-100">
                            <label class="block text-gray-700 text-xl font-bold mb-4">2. Logistics & Entry Details</label>

                            <!-- A. Cleaning Product Preference -->
                            <div class="mb-6 p-4 border border-gray-200 rounded-xl bg-blue-50">
                                <label class="block text-gray-700 font-semibold mb-3">2a. Cleaning Products: Who is providing them? <span class="text-red-500">*</span></label>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="radio-card">
                                        <input type="radio" id="products_scrubit" name="product_preference" value="ScrubIt" required>
                                        <label for="products_scrubit" class="block p-4 border-2 border-gray-200 rounded-xl cursor-pointer transition-all duration-200 hover:border-custom-blue shadow-sm text-center">
                                            <i class="fa-solid fa-bottle-droplet text-2xl text-custom-blue mb-2"></i>
                                            <span class="font-medium text-gray-800 block">ScrubIt Provides</span>
                                            <span class="text-xs text-gray-500">We bring eco-friendly supplies.</span>
                                        </label>
                                    </div>
                                    <div class="radio-card">
                                        <input type="radio" id="products_client" name="product_preference" value="Client" required>
                                        <label for="products_client" class="block p-4 border-2 border-gray-200 rounded-xl cursor-pointer transition-all duration-200 hover:border-custom-blue shadow-sm text-center">
                                            <i class="fa-solid fa-hand-holding-box text-2xl text-custom-blue mb-2"></i>
                                            <span class="font-medium text-gray-800 block">Client Provides</span>
                                            <span class="text-xs text-gray-500">Cleaner uses your supplies/brands.</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- B. Access Method -->
                            <div class="p-4 border border-gray-200 rounded-xl bg-blue-50">
                                <label class="block text-gray-700 font-semibold mb-3">2b. How will the cleaner access the property? <span class="text-red-500">*</span></label>
                                <select id="access_method" name="access_method" required onchange="handleAccessMethodChange()" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-custom-blue focus:border-custom-blue transition-colors">
                                    <option value="" disabled selected>Select access method</option>
                                    <option value="Lockbox/Code">Key in Lockbox / Numeric Code</option>
                                    <option value="In-Person Handover">Meet Cleaner in Person</option>
                                    <option value="Concierge/Front Desk">Concierge / Front Desk Drop-off</option>
                                    <option value="Other">Other (e.g. key hidden, friend assisting)</option>
                                </select>
                                
                                <textarea id="access_details" name="access_details" placeholder="Please provide detailed instructions (e.g., Lockbox location and code, specific entry instructions, etc.)" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-custom-blue focus:border-custom-blue transition-colors mt-4" style="display: none;"></textarea>
                            </div>
                        </div>

                        <!-- 3. Booking Summary -->
                        <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                            <h3 class="text-xl font-bold text-custom-green mb-4">3. Booking Summary</h3>
                            <div id="summary-details" class="space-y-2 text-gray-700 text-sm">
                                <!-- Details will be populated by JavaScript -->
                                <p><strong>Service:</strong> <span id="summary_service">-</span></p>
                                <p><strong>Property Size:</strong> <span id="summary_size">-</span></p>
                                <p><strong>Date & Time:</strong> <span id="summary_datetime">-</span></p>
                                <p><strong>Address:</strong> <span id="summary_address">-</span></p>
                                <p><strong>Add-ons:</strong> <span id="summary_extras">-</span></p>
                                <p><strong>Cleaning Products:</strong> <span id="summary_products">-</span></p>
                                <p><strong>Property Access:</strong> <span id="summary_access">-</span></p>
                            </div>
                            <div class="mt-4 pt-4 border-t border-gray-200 flex justify-between items-center">
                                <span class="text-2xl font-bold text-gray-800">Total Price:</span>
                                <span id="summary_price" class="text-3xl font-extrabold text-custom-blue">$0.00</span>
                            </div>
                        </div>

                        <!-- Agreement -->
                        <div class="flex items-start">
                            <input type="checkbox" id="agreement" name="agreement" required class="mt-1 w-5 h-5 text-custom-green bg-gray-100 border-gray-300 rounded focus:ring-custom-green">
                            <label for="agreement" class="ml-2 text-sm text-gray-600">
                                I agree to the <a href="#" class="text-custom-blue hover:underline font-medium">Terms of Service</a> and confirm all details are correct. <span class="text-red-500">*</span>
                            </label>
                        </div>

                    </div>
                </div>

                <!-- === FORM CONTROLS === -->
                <div class="flex flex-col md:flex-row justify-between pt-6 space-y-4 md:space-y-0 md:space-x-4">
                    <button type="button" id="prev-button" onclick="prevStep()" class="flex items-center justify-center text-sm px-6 py-3 border border-gray-300 rounded-lg shadow-sm hover:bg-gray-100 transition-colors hidden">
                        <i class="fa-solid fa-arrow-left mr-2"></i> Back
                    </button>
                    <button type="button" id="next-button" onclick="nextStep()" class="flex-grow md:flex-none md:ml-auto flex items-center justify-center text-sm px-8 py-3 bg-custom-green text-white rounded-lg shadow-lg hover:bg-custom-green transition-colors disabled:opacity-50">
                        Next Step <i class="fa-solid fa-arrow-right ml-2"></i>
                    </button>
                    <button type="button" id="submit-button" onclick="submitBooking()" class="flex-grow md:flex-none md:ml-auto flex items-center justify-center text-sm px-8 py-3 bg-custom-blue text-white rounded-lg shadow-lg hover:bg-custom-blue transition-colors hidden disabled:opacity-50" disabled>
                        <i class="fa-solid fa-calendar-check mr-2"></i> Confirm Booking
                    </button>
                </div>
            </form>

            <p class="text-center text-sm text-gray-500 mt-6">Need help? Visit our <a href="#" class="text-custom-green hover:underline font-semibold">Support Center</a>.</p>

        </div>
    </main>

    <!-- Bottom Mobile Navigation -->
    <footer class="md:hidden sticky bottom-0 left-0 w-full bg-white border-t border-gray-200 z-20">
        <div class="flex justify-around items-center h-16">
            <a href="#" class="flex flex-col items-center text-xs text-gray-500 hover:text-custom-green transition-colors">
                <i class="fa-solid fa-house text-xl mb-1"></i>
                Home
            </a>
            <a href="#" class="flex flex-col items-center text-xs text-custom-green font-medium">
                <i class="fa-solid fa-broom text-xl mb-1"></i>
                Book Now
            </a>
            <a href="#" class="flex flex-col items-center text-xs text-gray-500 hover:text-custom-green transition-colors">
                <i class="fa-solid fa-list-check text-xl mb-1"></i>
                My Bookings
            </a>
            <a href="#" class="flex flex-col items-center text-xs text-gray-500 hover:text-custom-green transition-colors">
                <i class="fa-solid fa-circle-question text-xl mb-1"></i>
                Support
            </a>
            <a href="#" id="profile-link-mobile" class="flex flex-col items-center text-xs text-gray-500 hover:text-custom-blue transition-colors">
                <i class="fa-solid fa-user text-xl mb-1"></i>
                Profile
            </a>
        </div>
    </footer>

    <!-- JavaScript for Form Logic -->
    <script>
        let currentStep = 1;
        const totalSteps = 3;
        const savedAddress = {
            address: "123 Clean Street, Apt 4B",
            city: "Metropolis",
            state: "CA",
            zip: "90210"
        };
        const priceMap = {
            'Standard': 100,
            'Deep': 150,
            'Move In/Out': 200,
            'Hourly': 40
        };

        // --- UI Helper Functions ---
        function toggleLoading(show, text = 'Processing...') {
            const overlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');
            if (show) {
                loadingText.textContent = text;
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        function showFormMessage(message, type = 'info') {
            const msgElement = document.getElementById('form-message');
            msgElement.textContent = message;
            msgElement.classList.remove('hidden', 'text-green-600', 'text-red-600', 'text-gray-600');
            
            switch (type) {
                case 'success':
                    msgElement.classList.add('text-green-600');
                    break;
                case 'error':
                    msgElement.classList.add('text-red-600');
                    break;
                case 'info':
                default:
                    msgElement.classList.add('text-gray-600');
                    break;
            }
            msgElement.classList.remove('hidden');
        }

        /**
         * Clears all message alerts.
         */
        function clearFormMessage() {
            document.getElementById('form-message').classList.add('hidden');
        }

        // --- Step Navigation Functions ---

        /**
         * Hides all steps and shows the current active step.
         */
        function updateStepUI() {
            clearFormMessage();
            document.querySelectorAll('.form-step').forEach(step => step.classList.add('hidden'));
            document.getElementById(`step-${currentStep}`).classList.remove('hidden');

            // Update title and buttons
            let title = '';
            let nextButtonText = 'Next Step <i class="fa-solid fa-arrow-right ml-2"></i>';
            document.getElementById('prev-button').classList.add('hidden');
            document.getElementById('next-button').classList.remove('hidden');
            document.getElementById('submit-button').classList.add('hidden');

            switch (currentStep) {
                case 1:
                    title = "Step 1: Choose Service & Size";
                    break;
                case 2:
                    title = "Step 2: Date & Location";
                    document.getElementById('prev-button').classList.remove('hidden');
                    break;
                case 3:
                    title = "Step 3: Extras, Logistics, & Confirmation";
                    document.getElementById('prev-button').classList.remove('hidden');
                    document.getElementById('next-button').classList.add('hidden');
                    document.getElementById('submit-button').classList.remove('hidden');
                    updateSummary(); // Update summary just before showing step 3
                    break;
            }

            document.getElementById('step-title').innerHTML = title;
            document.getElementById('next-button').innerHTML = nextButtonText;

            // Update indicators and progress bar
            const totalStepsCount = 3;
            document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                indicator.classList.remove('step-active', 'step-complete', 'bg-gray-300', 'text-gray-600');
                if (index + 1 < currentStep) {
                    indicator.classList.add('step-complete');
                    indicator.innerHTML = '<i class="fa-solid fa-check"></i>';
                } else if (index + 1 === currentStep) {
                    indicator.classList.add('step-active');
                    indicator.innerHTML = index + 1;
                } else {
                    indicator.classList.add('bg-gray-300', 'text-gray-600');
                    indicator.innerHTML = index + 1;
                }
            });

            // Update progress bar
            const progress = (currentStep - 1) / (totalStepsCount - 1) * 100;
            document.getElementById('progress-fill').style.width = `${progress}%`;
        }


        /**
         * Validates the fields in the current step before proceeding.
         * @param {number} step - The step number to validate.
         * @returns {boolean} - True if validation passes, false otherwise.
         */
        function validateStep(step) {
            const stepElement = document.getElementById(`step-${step}`);
            let isValid = true;
            let message = '';
            
            // Check required fields in the current step
            stepElement.querySelectorAll('[required]').forEach(input => {
                if (input.type === 'radio') {
                    const name = input.name;
                    if (!stepElement.querySelector(`input[name="${name}"]:checked`)) {
                        isValid = false;
                    }
                } else if (!input.value.trim()) {
                    isValid = false;
                }
            });

            // Step 3 specific validation (new fields)
            if (step === 3) {
                const accessMethod = document.getElementById('access_method').value;
                const accessDetails = document.getElementById('access_details');
                
                // If "Other" is selected, access details must be provided
                if (accessMethod === 'Other' && !accessDetails.value.trim()) {
                    isValid = false;
                    message = 'Please provide detailed instructions for property access.';
                }
                
                // Check Agreement (required field check handles this, but here for clarity)
                if (!document.getElementById('agreement').checked) {
                    isValid = false;
                    if (!message) message = 'You must agree to the Terms of Service to continue.';
                }
            }
            
            if (!isValid) {
                showFormMessage(message || 'Please complete all required fields for this step (*).', 'error');
                return false;
            }
            return true;
        }

        /**
         * Proceeds to the next step if the current step is valid.
         */
        function nextStep() {
            if (currentStep < totalSteps) {
                if (validateStep(currentStep)) {
                    currentStep++;
                    updateStepUI();
                }
            }
        }

        /**
         * Goes back to the previous step.
         */
        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepUI();
            }
        }

        // --- Data Handling ---

        /**
         * Toggles between using a saved address and manual input.
         */
        function toggleUseSavedAddress() {
            const useSaved = document.getElementById('use-saved-address').checked;
            const fields = ['address', 'city', 'state', 'zip'];

            if (useSaved) {
                document.getElementById('address').value = savedAddress.address;
                document.getElementById('city').value = savedAddress.city;
                document.getElementById('state').value = savedAddress.state;
                document.getElementById('zip').value = savedAddress.zip;
                fields.forEach(id => document.getElementById(id).disabled = true);
            } else {
                fields.forEach(id => {
                    const el = document.getElementById(id);
                    el.disabled = false;
                    el.value = '';
                });
            }
        }

        /**
         * Handles the display logic for the access_details textarea.
         */
        function handleAccessMethodChange() {
            const accessMethod = document.getElementById('access_method').value;
            const accessDetails = document.getElementById('access_details');

            if (accessMethod === 'Other') {
                accessDetails.style.display = 'block';
                accessDetails.setAttribute('required', 'required');
            } else {
                accessDetails.style.display = 'none';
                accessDetails.removeAttribute('required');
                accessDetails.value = ''; // Clear previous input
            }
        }
        
        /**
         * Calculates the estimated price. (Simplified Mock Logic)
         */
        function calculatePrice() {
            let basePrice = 0;
            const serviceType = document.querySelector('input[name="service_type"]:checked')?.value;
            const bedrooms = document.getElementById('bedrooms').value;
            const bathrooms = document.getElementById('bathrooms').value;
            let totalExtrasCost = 0;

            if (serviceType && bedrooms && bathrooms) {
                basePrice = priceMap[serviceType] || 0;
                
                // Adjust based on size (simplified)
                const sizeFactor = (parseInt(bedrooms) || 0) + (parseInt(bathrooms) || 0);
                basePrice += sizeFactor * 15; // $15 per room/bath
            }
            
            // Calculate extras cost (simplified)
            document.querySelectorAll('input[name="extras"]:checked').forEach(extra => {
                totalExtrasCost += 25; // $25 per extra
            });

            return basePrice + totalExtrasCost;
        }

        /**
         * Updates the booking summary section.
         */
        function updateSummary() {
            const serviceType = document.querySelector('input[name="service_type"]:checked')?.value || '-';
            const bedrooms = document.getElementById('bedrooms').value || '-';
            const bathrooms = document.getElementById('bathrooms').value || '-';
            const date = document.getElementById('service_date').value || '-';
            const time = document.getElementById('service_time').value || '-';
            
            const address = document.getElementById('address').value;
            const city = document.getElementById('city').value;
            const state = document.getElementById('state').value;
            const zip = document.getElementById('zip').value;
            
            const fullAddress = (address && city) ? `${address}, ${city}, ${state} ${zip}` : '-';

            const extras = Array.from(document.querySelectorAll('input[name="extras"]:checked'))
                                .map(el => el.value)
                                .join(', ') || 'None';

            // New fields
            const productPreference = document.querySelector('input[name="product_preference"]:checked')?.value || 'Not Selected';
            const accessMethod = document.getElementById('access_method').value || 'Not Selected';
            const accessDetails = document.getElementById('access_details').value.trim();
            
            let finalAccess = accessMethod;
            if (accessMethod === 'Other' && accessDetails) {
                finalAccess = `${accessMethod} (Details: ${accessDetails})`;
            }


            document.getElementById('summary_service').textContent = serviceType;
            document.getElementById('summary_size').textContent = `${bedrooms} Bed / ${bathrooms} Bath`;
            document.getElementById('summary_datetime').textContent = (date !== '-') ? `${date} @ ${time}` : '-';
            document.getElementById('summary_address').textContent = fullAddress;
            document.getElementById('summary_extras').textContent = extras;
            document.getElementById('summary_products').textContent = productPreference; // New summary field
            document.getElementById('summary_access').textContent = finalAccess; // New summary field

            document.getElementById('summary_price').textContent = `$${calculatePrice().toFixed(2)}`;
            
            // Enable submit button if all required fields in step 3 are valid
            document.getElementById('submit-button').disabled = !validateStep(3);
        }

        /**
         * Collects all form data into a single object.
         */
        function collectFormData() {
            const formData = new FormData(document.getElementById('booking-form'));
            const data = {};

            // Collect all fields
            formData.forEach((value, key) => {
                if (key === 'extras') {
                    // Handle multiple checkboxes for extras
                    if (!data[key]) data[key] = [];
                    data[key].push(value);
                } else {
                    data[key] = value;
                }
            });

            // Special handling for access details if "Other" is not selected (to ensure it's not included if empty)
            if (data['access_method'] !== 'Other') {
                delete data['access_details'];
            }

            return {
                ...data,
                total_price: calculatePrice().toFixed(2)
            };
        }


        // --- Submission Logic ---

        function submitBooking() {
            if (!validateStep(currentStep)) return;

            const bookingData = collectFormData();
            
            toggleLoading(true, 'Finalizing your booking...');

            // Simulate an async operation (like a network request to a hypothetical API endpoint)
            setTimeout(() => {
                console.log("--- Booking Confirmed (SIMULATED) ---");
                // Log the collected data to the console for inspection
                console.log(JSON.stringify(bookingData, null, 2));
                console.log("-------------------------------------");
                
                toggleLoading(false);
                
                // Show a clean confirmation message
                document.getElementById('booking-form').innerHTML = `
                    <div class="text-center p-8">
                        <i class="fa-solid fa-circle-check text-7xl text-custom-green mb-6 animate-pulse"></i>
                        <h2 class="text-3xl font-extrabold text-gray-800 mb-2">Booking Confirmed!</h2>
                        <p class="text-lg text-gray-600 mb-4">Your service has been scheduled for ${bookingData.service_date} in the ${bookingData.service_time.split('(')[0].trim()} slot.</p>
                        <p class="text-md font-medium text-custom-blue">A confirmation email with all details is on its way.</p>
                        <button onclick="window.location.reload()" class="mt-8 bg-custom-blue text-white px-6 py-3 rounded-lg shadow-lg hover:bg-custom-blue transition-colors">Book Another Service</button>
                    </div>
                `;
            }, 1500); // 1.5 second delay simulation
        }

        /**
         * Attaches listeners to all relevant form inputs to trigger summary and validation updates.
         */
        function attachInputListeners() {
            const form = document.getElementById('booking-form');
            form.addEventListener('change', (e) => {
                if (currentStep === totalSteps) {
                    updateSummary();
                }
            });
            form.addEventListener('input', (e) => {
                if (currentStep === totalSteps) {
                    updateSummary();
                }
            });
            
            // Specific listener for access method details
            document.getElementById('access_method').addEventListener('change', handleAccessMethodChange);
        }

        // --- Initialization ---

        function init() {
            updateStepUI();
            attachInputListeners();
            // Set minimum date to tomorrow
            const today = new Date();
            today.setDate(today.getDate() + 1);
            const minDate = today.toISOString().split('T')[0];
            document.getElementById('service_date').setAttribute('min', minDate);
        }

        // Expose functions globally for HTML access
        window.nextStep = nextStep;
        window.prevStep = prevStep;
        window.submitBooking = submitBooking;
        window.toggleUseSavedAddress = toggleUseSavedAddress;
        window.handleAccessMethodChange = handleAccessMethodChange;

        // Start the application setup when the window loads
        window.onload = init;
    </script>

</body>
</html>
